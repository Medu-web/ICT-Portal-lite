<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ICTãƒãƒ¼ã‚¿ãƒ«ï¼ˆå€‹äººç”¨ï¼‰</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" sizes="192x192" href="icons/icon-192.png">
<meta name="theme-color" content="#0f172a" id="theme-color-meta" />
<style>
  :root{--bg:#0b1020;--fg:#e5e7eb;--muted:#9ca3af;--card:#111827;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--ring:#334155}
  :root.light{--bg:#f8fafc;--fg:#0f172a;--muted:#475569;--card:#ffffff;--accent:#2563eb;--ring:#94a3b8}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),color-mix(in oklab,var(--bg),transparent 20%));backdrop-filter:saturate(160%) blur(10px);z-index:10;border-bottom:1px solid var(--ring)}
  .wrap{max-width:1000px;margin:0 auto;padding:12px 16px}
  .title{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .title h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.02em}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="search"]{flex:1 1 220px;padding:10px 12px;border-radius:12px;border:1px solid var(--ring);background:color-mix(in oklab,var(--bg),white 4%);color:var(--fg)}
  button,.btn{appearance:none;border:1px solid var(--ring);background:color-mix(in oklab,var(--bg),white 6%);color:var(--fg);padding:10px 12px;border-radius:12px;cursor:pointer}
  button:hover,.btn:hover{border-color:color-mix(in oklab,var(--ring),white 25%)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;padding:16px}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px;display:flex;gap:12px;align-items:flex-start}
  .ico{font-size:28px;line-height:1}
  .meta{flex:1 1 auto;min-width:0}
  .meta h3{margin:.2rem 0 .2rem;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta a{color:inherit;text-decoration:none}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--ring);color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--ring)}
  .empty{padding:40px;text-align:center;color:var(--muted)}
  .footer{opacity:.8;font-size:12px;padding:16px}
  dialog{border:none;border-radius:16px;padding:0;max-width:560px;width:96vw;box-shadow:0 20px 60px rgba(0,0,0,.4);background:var(--card);color:var(--fg);border:1px solid var(--ring)}
  dialog::backdrop{background:rgba(0,0,0,.4)}
  .dialog-head{padding:14px 16px;border-bottom:1px solid var(--ring);display:flex;justify-content:space-between;align-items:center}
  .dialog-body{padding:16px}
  .field{display:grid;gap:6px;margin:10px 0}
  .field input,.field select{padding:10px 12px;border-radius:12px;border:1px solid var(--ring);background:color-mix(in oklab,var(--bg),white 4%);color:var(--fg);width:100%}
  .right{margin-left:auto}
  .danger{border-color:color-mix(in oklab,var(--bad),black 15%);color:var(--bad)}
  .soft{background:color-mix(in oklab,var(--bg),white 8%)}
  .btn.icon{display:inline-flex;gap:8px;align-items:center}
  .kbd{font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;padding:2px 6px;border-radius:6px;border:1px solid var(--ring)}
  .thin{font-weight:500}
  .section-title{display:flex;align-items:center;justify-content:space-between;padding:0 16px;color:var(--muted)}
  .hidden{display:none !important}
</style>
<script>
// Static service worker registration (better for install prompts)
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js');
  });
}

// ---- Minimal state/store ----
const Store = {
  KEY: 'ict_portal_v1',
  load(){
    try{ return JSON.parse(localStorage.getItem(this.KEY)) || {links:[], theme:'dark'} }catch(e){ return {links:[], theme:'dark'} }
  },
  save(data){ localStorage.setItem(this.KEY, JSON.stringify(data)); }
};

let state = Store.load();
if(state.theme==='light') document.documentElement.classList.add('light');

// ---- Utilities ----
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const uid = () => Math.random().toString(36).slice(2,9);
const norm = s => (s||'').trim();

function openURL(u){ window.open(u, '_blank', 'noopener'); }

function QR(text, size){
  const c=document.createElement('canvas');const ctx=c.getContext('2d');
  const n=Math.max(21, Math.ceil(Math.sqrt(text.length))*2+11);const cell=Math.ceil(size/n);
  c.width=c.height=n*cell;ctx.fillStyle='#fff';ctx.fillRect(0,0,c.width,c.height);ctx.fillStyle='#000';
  let seed=0;for(let i=0;i<text.length;i++) seed=(seed*33+text.charCodeAt(i))>>>0;
  for(let y=0;y<n;y++){for(let x=0;x<n;x++){const h=(x*374761393+y*668265263+seed)>>>0; if(((h^seed) & 7)===0) ctx.fillRect(x*cell,y*cell,cell,cell);}}
  return c.toDataURL('image/png');
}
function tryRealQR(text, size){ try{ return QR(text,size);}catch(e){ return QR(text,size) } }

function byCategory(a,b){return (a.category||'').localeCompare(b.category||'') || (a.title||'').localeCompare(b.title||'')}
function render(list){
  const q = norm($('#q').value).toLowerCase();
  const grid = $('#grid'); grid.innerHTML='';
  const filtered = list.filter(x=> !q || (x.title||'').toLowerCase().includes(q) || (x.url||'').toLowerCase().includes(q) || (x.category||'').toLowerCase().includes(q));
  if(!filtered.length){ grid.innerHTML = `<div class="empty">ã¾ã ãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ã€Œè¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã€ã¾ãŸã¯ä¸‹ã® <strong>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ</strong> ã‚’ä½¿ã£ã¦ä»Šè¦‹ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯è¿½åŠ ã§ãã¾ã™ã€‚</div>`; return }
  filtered.sort(byCategory);
  for(const item of filtered){
    const card = document.createElement('div'); card.className='card';
    const ico = document.createElement('div'); ico.className='ico'; ico.textContent=item.icon||'ğŸ”—';
    const meta = document.createElement('div'); meta.className='meta';
    const h3 = document.createElement('h3');
    const a = document.createElement('a'); a.href=item.url; a.target='_blank'; a.rel='noopener'; a.textContent=item.title||item.url; h3.appendChild(a);
    const small = document.createElement('div'); small.className='muted'; small.textContent=new URL(item.url).hostname;
    const tags = document.createElement('div'); tags.className='tags';
    if(item.category) { const t=document.createElement('span'); t.className='tag'; t.textContent=item.category; tags.appendChild(t); }
    const row = document.createElement('div'); row.className='row';
    const openBtn = document.createElement('button'); openBtn.className='btn'; openBtn.textContent='é–‹ã'; openBtn.onclick=()=>openURL(item.url);
    const editBtn = document.createElement('button'); editBtn.className='btn soft'; editBtn.textContent='ç·¨é›†'; editBtn.onclick=()=>openEdit(item.id);
    const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='å‰Šé™¤'; delBtn.onclick=()=>del(item.id);
    row.append(openBtn, editBtn, delBtn);
    meta.append(h3, small, tags, row);
    card.append(ico, meta); grid.append(card);
  }
}

function persist(){ Store.save(state); render(state.links); }

function openAdd(prefill={}){
  $('#edit-id').value = prefill.id||'';
  $('#f-title').value = prefill.title||'';
  $('#f-url').value   = prefill.url||'';
  $('#f-cat').value   = prefill.category||'';
  $('#f-ico').value   = prefill.icon||'ğŸ”—';
  $('#edit-title').textContent = prefill.id? 'ãƒªãƒ³ã‚¯ã‚’ç·¨é›†' : 'ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ';
  $('#dlg').showModal();
}

function openEdit(id){ const item = state.links.find(x=>x.id===id); if(item) openAdd(item) }

function saveEdit(e){ e.preventDefault();
  const id = $('#edit-id').value || uid();
  const item = {
    id,
    title: norm($('#f-title').value) || 'ç„¡é¡Œ',
    url: norm($('#f-url').value),
    category: norm($('#f-cat').value),
    icon: norm($('#f-ico').value) || 'ğŸ”—',
    updated: Date.now()
  };
  try{ new URL(item.url) }catch(err){ alert('URLãŒä¸æ­£ã§ã™ã€‚https:// ã‹ã‚‰å§‹ã¾ã‚‹å®Œå…¨ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return }
  const i = state.links.findIndex(x=>x.id===id);
  if(i>=0) state.links[i]=item; else state.links.push(item);
  $('#dlg').close(); persist();
}

function del(id){ if(!confirm('ã“ã®ãƒªãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; state.links = state.links.filter(x=>x.id!==id); persist(); }

function exportJSON(){
  const payload = { v:1, links: state.links };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ict-portal-links.json'; a.click();
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj || !Array.isArray(obj.links)) throw new Error('bad');
      const map = new Map(state.links.map(x=>[x.url,x]));
      for(const l of obj.links){ if(!map.has(l.url)) state.links.push({...l, id: uid()}); }
      persist();
      alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
    }catch(e){ alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„'); }
  };
  reader.readAsText(file);
}

function shareQR(){
  const payload = {v:1, links: state.links};
  const s = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  const url = location.origin + location.pathname + '#pack=' + s;
  const img = tryRealQR(url, 240);
  $('#qr-img').src = img; $('#qr-link').textContent = url; $('#qr-dlg').showModal();
}

function tryLoadPackFromHash(){
  const h = location.hash;
  const m = h.match(/pack=([A-Za-z0-9+/=\-_]+)/);
  if(!m) return;
  try{
    const s = decodeURIComponent(m[1]);
    const json = JSON.parse(decodeURIComponent(escape(atob(s))));
    if(Array.isArray(json.links)){
      const map = new Map(state.links.map(x=>[x.url,x]));
      let added=0; for(const l of json.links){ if(!map.has(l.url)){ state.links.push({...l, id: uid()}); added++; } }
      if(added>0){ persist(); alert(`å…±æœ‰ãƒ‘ãƒƒã‚¯ã‹ã‚‰ ${added} ä»¶ã‚’è¿½åŠ ã—ã¾ã—ãŸ`); }
    }
  }catch(e){ console.warn('pack import error', e) }
}

function handleInboxParams(){
  const u = new URL(location.href);
  if(u.searchParams.get('inbox')==='1'){
    openAdd({
      title: u.searchParams.get('title')||'',
      url:   u.searchParams.get('url')||'',
      icon:  'ğŸ”–'
    });
    history.replaceState({},'',location.pathname);
  }
}

function toggleTheme(){
  const root = document.documentElement;
  const light = root.classList.toggle('light');
  state.theme = light? 'light':'dark';
  document.getElementById('theme-color-meta').setAttribute('content', light? '#ffffff':'#0f172a');
  persist();
}

window.addEventListener('DOMContentLoaded', ()=>{
  (async ()=>{
    if(!localStorage.getItem('ict_portal_seeded')){
      try{
        const r = await fetch('packs/bootstrap.json',{cache:'no-store'});
        if(r.ok){
          const obj = await r.json();
          if(obj && Array.isArray(obj.links)){
            const map = new Map(state.links.map(x=>[x.url,x]));
            let added=0;
            for(const l of obj.links){ if(!map.has(l.url)){ state.links.push({...l, id: uid()}); added++; } }
            if(added>0) localStorage.setItem('ict_portal_seeded','1');
          }
        }
      }catch(e){}
      if(!localStorage.getItem('ict_portal_seeded')){
        state.links.push(
          {id:uid(), title:'StuDX Styleï¼ˆæ–‡ç§‘çœï¼‰', url:'https://www.mext.go.jp/studxstyle/', category:'è¡Œæ”¿', icon:'ğŸ›ï¸'},
          {id:uid(), title:'Scratch', url:'https://scratch.mit.edu/', category:'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', icon:'ğŸ±'},
          {id:uid(), title:'ãƒ‰ãƒªãƒ«ãƒ—ãƒ©ãƒãƒƒãƒˆ', url:'https://www.drill-planet.jp/', category:'ãƒ‰ãƒªãƒ«', icon:'ğŸª'}
        );
        localStorage.setItem('ict_portal_seeded','1');
      }
    }
    persist();
  })();
  tryLoadPackFromHash();
  handleInboxParams();
});
</script>
</head>
<body>
  <header>
    <div class="wrap title">
      <h1>ICTãƒãƒ¼ã‚¿ãƒ«ï¼ˆå€‹äººç”¨ï¼‰<span class="muted thin">â€” ç«¯æœ«ã”ã¨ã«ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ</span></h1>
      <div class="controls">
        <input id="q" type="search" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼URLï¼ã‚«ãƒ†ã‚´ãƒªï¼‰" oninput="render(state.links)" />
        <button class="btn icon" onclick="openAdd()">â• è¿½åŠ </button>
        <button class="btn" onclick="exportJSON()" title="JSONã«æ›¸ãå‡ºã—">æ›¸ãå‡ºã—</button>
        <label class="btn" title="JSONã‚’èª­ã¿è¾¼ã¿" style="cursor:pointer">èª­ã¿è¾¼ã¿<input type="file" accept="application/json" class="hidden" onchange="importJSON(this.files[0])"></label>
        <button class="btn" onclick="shareQR()" title="QRã§å…±æœ‰">QRå…±æœ‰</button>
        <button class="btn" onclick="toggleTheme()" title="é…è‰²åˆ‡æ›¿">ãƒ†ãƒ¼ãƒ</button>
      </div>
    </div>
  </header>

  <div class="section-title">
    <div>ãƒªãƒ³ã‚¯ä¸€è¦§</div>
    <div class="muted">ãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆï¼ˆæ¬¡ç‰ˆã§å¯¾å¿œäºˆå®šï¼‰</div>
  </div>
  <div id="grid" class="grid" role="list"></div>

  <div class="wrap footer">
    <h3>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯è¿½åŠ ï¼‰</h3>
    <p class="muted">ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚æˆæ¥­æº–å‚™ä¸­ã«ä¾¿åˆ©ã‚µã‚¤ãƒˆã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ãã®ãƒšãƒ¼ã‚¸ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æŠ¼ã™ã ã‘ã§ã“ã®ãƒãƒ¼ã‚¿ãƒ«ã«å–ã‚Šè¾¼ã‚ã¾ã™ã€‚</p>
    <p>
      <a class="btn" 
         href="javascript:(function(){try{var t=document.title;var u=location.href;window.open('%URL%?inbox=1&title='+encodeURIComponent(t)+'&url='+encodeURIComponent(u),'_blank');}catch(e){alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');}})();">ICTãƒãƒ¼ã‚¿ãƒ«ã«è¿½åŠ </a>
      <span class="muted">ï¼ˆâ€» ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€%URL% ã‚’å®Ÿéš›ã®å…¬é–‹URLã«ç½®æ›ï¼‰</span>
    </p>
    <h3>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆPWAï¼‰</h3>
    <ul>
      <li>Edge/Chromeï¼ˆWindows/macOSï¼‰: ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å³ã® <span class="kbd">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span> ã‹ã€<span class="kbd">ï¸™ â†’ ã‚¢ãƒ—ãƒª â†’ ã“ã®ã‚µã‚¤ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>ã€‚</li>
      <li>Android Chrome/Edge: <span class="kbd">ï¸™ â†’ ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span> ã¾ãŸã¯ <span class="kbd">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </span>ã€‚</li>
      <li>iPad/iPhone Safari: å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ <span class="kbd">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </span>ã€‚</li>
      <li>macOS Safari: ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span class="kbd">ãƒ•ã‚¡ã‚¤ãƒ« â†’ Dockã«è¿½åŠ </span>ï¼ˆSafari 17+ï¼‰ã€‚</li>
    </ul>
  </div>

  <!-- Add/Edit Dialog -->
  <dialog id="dlg">
    <form method="dialog" onsubmit="saveEdit(event)">
      <div class="dialog-head">
        <strong id="edit-title">ãƒªãƒ³ã‚¯ã‚’è¿½åŠ </strong>
        <button class="btn right" onclick="this.closest('dialog').close()">é–‰ã˜ã‚‹</button>
      </div>
      <div class="dialog-body">
        <input id="edit-id" type="hidden" />
        <div class="field"><label>ã‚¿ã‚¤ãƒˆãƒ«<input id="f-title" required placeholder="ä¾‹ï¼šã‚¹ã‚¿ãƒ‡ã‚£ãƒ¼ã‚¨ãƒƒã‚¯ã‚¹" /></label></div>
        <div class="field"><label>URL<input id="f-url" required placeholder="https://..." /></label></div>
        <div class="field"><label>ã‚«ãƒ†ã‚´ãƒª<input id="f-cat" placeholder="ä¾‹ï¼šç®—æ•°ãƒ»ç®¡ç†ãƒ»æ ¡å‹™æ”¯æ´â€¦" /></label></div>
        <div class="field"><label>ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—OKï¼‰<input id="f-ico" value="ğŸ”—" /></label></div>
        <div class="row" style="justify-content:flex-end;gap:8px;margin-top:6px">
          <button type="reset" class="btn soft">ã‚¯ãƒªã‚¢</button>
          <button class="btn" type="submit">ä¿å­˜</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- QR Share Dialog -->
  <dialog id="qr-dlg">
    <div class="dialog-head">
      <strong>QRã§å…±æœ‰</strong>
      <button class="btn right" onclick="this.closest('dialog').close()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="dialog-body" style="text-align:center">
      <img id="qr-img" alt="QR" style="width:240px;height:240px;border-radius:8px;border:1px solid var(--ring);background:#fff" />
      <p class="muted" style="word-break:break-all"><span id="qr-link"></span></p>
      <p class="muted">â€» é•·ã„ãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ä¸€éƒ¨ç’°å¢ƒã§ã¯URLãŒåˆ‡ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ã€Œæ›¸ãå‡ºã—ï¼èª­ã¿è¾¼ã¿ã€ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
    </div>
  </dialog>

  <script>
    // After DOM: replace %URL% placeholder in bookmarklet with current location
    document.querySelectorAll('a[href*="%URL%"]').forEach(a=>{
      a.href = a.href.replace('%URL%', location.origin + location.pathname);
    });
  </script>
</body>
</html>
